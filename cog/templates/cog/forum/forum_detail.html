{% extends "cog/common/layout_sidebar_center.html" %}

{% block main %}

    {% load comments %}
    {% load pagination_tags %}
    {% autopaginate topics 20 %}
    {% load cog_utils %}
    
    <!-- one table per topic -->
    {% for topic in topics %}
   		<div class="mybox">
	    	<table>
	        	<caption>
	        		{{ topic|is_locked:request }} <a href="{% url 'topic_detail' project.short_name topic.id %}">{{ topic.title }}</a>
	        		{% include 'cog/forum/_topic_links.html' %} 			
	        	</caption>
    			<!-- one row per thread -->
    			{% for thread in topic.get_threads %}
    				{% get_comment_count for thread as comment_count %}
					<tr>
						<td>
							<a href="{% url 'thread_detail' project.short_name thread.id %}">{{ thread.title }}</a>
							<br/>
	    					Started by {{ thread.author }} on {{ thread.create_date }}, {{ comment_count }} post{{comment_count|pluralize}}.
		    				{% if comment_count > 0 %}
		    					Last post on {{ thread.get_last_comment.submit_date }} by {{ thread.get_last_comment.user }}.
		    				{% endif %}							
						</td>
					</tr>
    			{% empty %}
    				<tr>
    					<td>
    						<i>This Topic has no Threads yet.</i>
    					</td>
    				</tr>
    			{% endfor %}


    			<!-- link to start new thread -->
    			{% if user|hasUserPermission:project %}
	    			<tr>
	    				<td>Start a <a href="{% url 'thread_add' project.short_name topic.id %}" class="changelink">new Thread</a> about this Topic.</td>
	    			</tr>
    			{% endif %}	
    			
    		</table>
    	</div>
    {% empty %}
    	<i>This Forum has no Topics yet.</i>
    {% endfor %}
    
	{% paginate %}
	
	<br/>
	Forum Topics can only be created by project administrators. Project members can create new Threads for each Topic, after they <a href="{% url 'login' %}?next={{ request.path }}"> login</a>.
	<br/>
		
	<!-- new forum topic form -->
	{% if user|hasAdminPermission:project %}
		&nbsp;
		<hr/>
	  	<form action="" method="post">
		    {% csrf_token %}	
			<table>
				<tr>
					<td nowrap="nowrap">
						<span style="vertical-align: middle">Start a new <b>Topic</b>:</span>
					</td>
					<td class="long">
						<span style="vertical-align: middle">
							{{ form.title }} 
							<br/>{{ form.title.errors }}
							{{ form.is_private }} This Topic is private (can only be viewed by project members)
							&nbsp;<input type="submit" value="Submit"/>
						</span>
					</td>
				</tr>
			</table>
	  	</form>
	{% endif %}
	
	
{% endblock %}