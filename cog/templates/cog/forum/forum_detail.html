{% extends "cog/common/layout_sidebar_center.html" %}

{% block main %}

    {% load comments %}
    {% load pagination_tags %}
    {% autopaginate threads 10 %}
    {% load cog_utils %}
    
     <div class="mybox">
	    <table>
	        <caption>{{ project.short_name }} Forum Discussions</caption>
    
    		{% if threads %}
	    		<!-- loop over forum threads -->
	    		{% for thread in threads %}
	    			{% get_comment_count for thread as comment_count %}
	    			<tr>
	    				<td>{{ page_obj.start_index|add:forloop.counter|add:-1}}</td>
	    				<td>
	    					<b><a href="{% url 'thread_detail' project.short_name thread.id %}">{{ thread.title }}</a></b>
	    					{{ thread|is_locked:request }} 
	    					<hr/>
	    					Started by {{ thread.author }} on {{ thread.create_date }}, {{ comment_count }} comments.
	    					{% if comment_count > 0 %}
	    						Last comment on {{ thread.get_last_comment.submit_date }} by {{ thread.get_last_comment.user }}.
	    					{% endif %}
	    				</td>
	    			</tr>
	    		{% endfor %}
	    	{% else %}
	    		<tr>
	    			<td><i>This forum has no threads yet.</i></td>
	    		</tr>
	    	{% endif %}
    
		</table>
	</div>

	{% paginate %}
		
	<hr/>		
	<!-- new forum thread form -->
	{% if user|hasUserPermission:project %}
		<table>
			<tr>
				<td>
					<form action="" method="post">
						{% csrf_token %}	
						<span style="vertical-align: middle; font-weight:bold">Start a new Thread:</span>
						<input style="vertical-align: middle; width:70%;" type="text" name="title" id="title" value="{{request.POST.title}}" />
						<input style="vertical-align: middle;" type="submit" value="Submit" />
						<br/>
						{{ form.title.errors }}
						Thread title must be non-empty and must not contain special characters.
						&nbsp; &nbsp;
						{{ form.is_private }} This thread is private (can only be viewed by project members)
					</form>
				</td>
			</tr>
		</table>
	{% else %}
    	You must 
		{% if user.is_anonymous %}
		<a href="{% url 'login' %}?next={{ request.path }}">login</a> and
		{% endif %}
		<a href="{% url 'membership_request' project.short_name|lower %}">join the {{ project.short_name }} project</a>
		to start a new thread.
	{% endif %}
	
{% endblock %}