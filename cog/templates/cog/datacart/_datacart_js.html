<script language="javascript">

	// function to select/deselect all items in cart
	function toggleAllDataCartItems() {
		
		// get status of 'master' datacart checkbox
		var dcCheckbox = document.getElementById("datacart-checkbox");
		var bool = dcCheckbox.checked;
		
		// set status of all dataitems checkboxes to be the same
		var inputs = document.getElementsByTagName("input");
		for (var i = 0; i < inputs.length; i++) {
		    if (inputs[i].type == "checkbox") {
		    	if (inputs[i].id!=null && inputs[i].id.length>0 && inputs[i].id.indexOf("dataitem-checkbox")==0) {
		        	inputs[i].checked = bool;
		    	}
		    }  
		}
		
	}

	// function to add an item to the user data cart
	function addToCart(id, metadata) {
				
		// relative path to COG application
		// note: cannot execute HTTP requests to other hosts because of javascript security restrictions
		// NOTE: the following URL requires the user to be logged in (otherwise request.user.id is None)
		var url = "{% url 'datacart_add' site.id request.user.id %}";
		var data = "id="+encodeURIComponent(id)
		         + "&metadata="+encodeURIComponent(metadata);
		
		// execute asynchronous POST request
		var transaction = YAHOO.util.Connect.asyncRequest('POST', url, addCallback, data);
	}
	
	function deleteFromCart(item_identifier) {
				
		// relative path to COG application
		// note: cannot execute HTTP requests to other hosts because of javascript security restrictions
		var url = "{% url 'datacart_delete' site.id request.user.id %}"
		var data = "item="+encodeURIComponent(item_identifier);
		
		// execute asynchronous GET request
		var transaction = YAHOO.util.Connect.asyncRequest('POST', url, deleteCallback, data);
		
	}
	// function to obtain the HTML id for the files container
	function getFilesDiv(dataset_id) {
		id = "files_"+dataset_id;
		return document.getElementById(id);
	}
	
	// function to return the HTTP parameter string for "&query=..."
	function getQueryFilter() {
		
		var q = "";
		var qdiv = document.getElementById("query-filter");
		if (qdiv!=null) {
			var query = qdiv.value.trim();
			if ( query.length > 0 ) q = "&query="+encodeURI(query);
		}
		return q;
		
	}
	
	// default number of files to retrieve
	var DEFAULT_LIMIT=10;
		
	// function to retrieve the files belonging to a given dataset
	function showFiles(dataset_id, index_node, limit, project) {
		
	  fdiv = getFilesDiv(dataset_id);
	  		  						
	  if (limit==0) limit=DEFAULT_LIMIT;
		
	  // relative path to COG application
	  // note: cannot execute HTTP requests to other hosts because of javascript security restrictions
	  // note: do not use django URL tag because it is interpreted before the 'dataset_id', 'index_node' values are known
	  var url = "/search_files/"+dataset_id+"/"+index_node+"/?limit="+limit
	          // add optional query filter
			  + getQueryFilter();
	  
	  // pass in extra arguments to callback functions
	  filesCallback.argument[0] = project
	  filesCallback.argument[1] = index_node
	  filesCallback.argument[2] = dataset_id
		
	  // execute asynchronous GET request
	  var transaction = YAHOO.util.Connect.asyncRequest('GET', url, filesCallback, null);
		
	  // show waiting panel
	  showWaitPanel();	
		
	}
	
	// function to return the "[ Close ]" link for a widget panel
	function getCloseLink(widget_id) {
		return "<span style='float:right;'>[ <a href='javascript:set_visibility(\""
			  + widget_id
			  +"\",false)' class='deletelink'>Close</a> ]</span>";
	}
	
	// function called if Ajax request succeded to create the files display widget
	var handleFilesSuccess = function(o) {
		
		// hide waiting panel
		hideWaitPanel();
		
		// retrieve callback extra argument
		project = o.argument[0]
		index_node = o.argument[1]
		dataset_id = o.argument[2]
		
		// parse JSON response into object		
		var jsonResponse = eval('(' + o.responseText + ')');
		var numFound = jsonResponse.response.numFound;
		var docs = jsonResponse.response.docs;
		var dataset_id = null;
		for (var k=0; k<jsonResponse.responseHeader.params.fq.length; k++) {
			var fqArray = jsonResponse.responseHeader.params.fq[k].split(":");
			if (fqArray[0]=='dataset_id') {
				dataset_id = fqArray[1].replace(/\"/g,'');
			}	
		}
		
		// populate files container
		var fdiv = getFilesDiv(dataset_id);
		
		var html = getCloseLink("files_"+dataset_id);
		html  += "<div style='text-align:center; font-weight:bold'>Total Number of Files: "+numFound+"</div>";
		if (numFound>0) {
			html += "<table>";
			for (var i=0; i<docs.length; i++) {
				var doc = docs[i];
				html += "<tr><td>"+(i+1)+"</td>"
				     +  "<td><b>"+doc.title+"</b>";
				
				// display additional file-level metadata 
				var keys = []
				for (var field in doc) {
					// display lots of file metadata
					//if (field != 'data_node' && field != 'index_node' && field != 'type' 
					//	&& field != 'id' && field != 'dataset_id' && field != 'score' 
					//	&& field != 'url' && field != 'subtype'
					//	&& field != 'dataset_id_template_' 
					//	&& field != 'instance_id' && field != 'master_id'
					//	&& field != 'metadata_format' && field != 'timestamp'
					//	&& field != 'title'
					//	&& field != 'history'
					//	&& field != 'latest' && field != 'replica') {
					//	keys[keys.length] = field;
					//}
					// display only some file metadata
					if (field == 'checksum' || field == 'size' || field == 'tracking_id') {
						keys[keys.length] = field;
					}
				}
				// loop over metadata keys in alphabetical order
				keys = keys.sort();
				for (var j=0; j<keys.length; j++) {
					key = keys[j];
					html += "<br/><span style='text-transform:capitalize;'>"+key +"</span>: "+doc[key];
				}
				
				//if (doc.subtype == 'image') {
				html += "<br/><a href='/metadata_display/"+project
				     +"?id="+doc.id
				     +"&dataset_id="+doc.dataset_id
				     +"&index_node="+doc.index_node
				     +"&type="+doc.type
				     +"&subtype="+doc.subtype
				     +"&back={{request.get_full_path}}" // add current URL with query string to provide 'back' link
				     +"'>Full File Metadata</a>";
				//}
				
				html += "</td><td>";
				
				// file access
				if (doc.url) {
					
					var thumbnailUrl = null;
					var imageUrl = null;
					
					// loop over file access URLs, create hyperlinks
					for (var j=0; j<doc.url.length; j++) {
						var urlArray = doc.url[j].split('|');
						
						// special case: 'Thumbnail' service
						if (urlArray[2].toLowerCase() == 'thumbnail') {
							thumbnailUrl = urlArray[0]; // store thumbnail URL for later replacement
							
						} else {
							
							// images: create hyperlink with graphic
							if (urlArray[1].indexOf("image")>=0) {
								html += "<a href='"+urlArray[0]+"'><img src='IMAGE_URL' width='50px'/></a>&nbsp;"; // 'IMAGE_URL'
								imageUrl = urlArray[0]; // always store reference to image URL
								
							// non-images: create hyperlink with text
							} else {
								html += "<a href='"+urlArray[0]+"'>"+urlArray[2]+"</a><br/>";
							}
						}						
					} // loop over URLs
					
					// replace placeholder with thumbnail of full image
					if (html.indexOf("IMAGE_URL")>0) {
						if (thumbnailUrl!=null) {
							html = html.replace("IMAGE_URL",thumbnailUrl);								
						} else {
							html = html.replace("IMAGE_URL",imageUrl);
						}
					}

				} // file access
				 
				html += "</td></tr>";
			}
			html += "</table>";
		}
		
		// link to show more files
		if (docs.length < numFound) {
			var url = "javascript:showFiles('"+dataset_id+"','"+index_node+"','"+numFound+"','"+project+"')";
			html += "<div style='text-align:center'><a href=\""+url+"\">Show All Files</a></style>";
			
		// link to show less files
		} else if (docs.length > DEFAULT_LIMIT) {
			var url = "javascript:window.scrollTo(0,0); " // must resize the scrollbar
				    + "javascript:showFiles('"+dataset_id+"','"+index_node+"','"+DEFAULT_LIMIT+"','"+project+"')";
			html += "<div style='text-align:center'><a href=\""+url+"\">Show Less Files</a></style>";

		}
		
		fdiv.innerHTML = html;
				
	}

	
	// function called if Ajax request succeded
	var handleAddSuccess = function(o) {
		
		// parse JSON response into object		
		var jsonResponse = eval('(' + o.responseText + ')');
		
		// update data cart size
		var size = jsonResponse['datacart_size'];
		element = document.getElementById("datacart_size");
		element.innerHTML = ""+size;
		
		var identifier = jsonResponse['item'];
		
		<!-- show 'delete' link -->
		set_visibility("datacart-delete-"+identifier, true);
		<!-- hide 'add' link -->
		set_visibility("datacart-add-"+identifier, false);
		
		// show messages
		var message = jsonResponse['message'];
		if (message) {
			showMessage("Warning", message);
		}
		
	}
	
	// function called if Ajax request succeded
	var handleDeleteSuccess = function(o) {
		
		// parse JSON response into object		
		var jsonResponse = eval('(' + o.responseText + ')');
		var size = jsonResponse['datacart_size'];
		var identifier = jsonResponse['item'];
		
		<!-- update datacart size -->
		element = document.getElementById("datacart_size");
		element.innerHTML = ""+size;
		
		<!-- remove item from datacart -->
		set_visibility("item_"+identifier, false);
		set_visibility("item_"+identifier+"_hr", false);
				
		<!-- hide 'delete' link -->
		set_visibility("datacart-delete-"+identifier, false);
		<!-- show 'add' link -->
		set_visibility("datacart-add-"+identifier, true);

		
	}
	
	// function to execute a request to a single index node
	// for a wget script spanning one or more datasets
	function wgetScript(index_node, ids) {
		
		// NOTE: must transform the "," separated string into array of dataset ids
		ids = ids.split(",");
		
		// FIXME: relative wget URL is hard-wired to ESGF web service endpoint
		var url = "http://"+index_node+"/esg-search/wget/?distrib=false"
                // add optional query filter
		        + getQueryFilter();
	
		// add dataset ids
		for (i=0; i<ids.length; i++) {
			url += "&dataset_id="+encodeURIComponent(ids[i]);
		}

		// execute synchronous request for one wget script
		window.location.href = url;
		
	}
	
	// function called if Ajax request to wget endpoint succeded
	var handleWgetSuccess = function(o) {

		// parse JSON response into object		
		/** example JSON response:
			{
			   u'pcmdi9.llnl.gov':[
			      u'cmip5.output1.INM.inmcm4.1pctCO2.day.atmos.day.r1i1p1.v20110323|pcmdi9.llnl.gov',
			      u'cmip5.output1.INM.inmcm4.esmHistorical.fx.atmos.fx.r0i0p0.v20110927|pcmdi9.llnl.gov',
			      u'cmip5.output1.INM.inmcm4.1pctCO2.day.ocean.day.r1i1p1.v20110323|pcmdi9.llnl.gov'
			   ]
			}
		*/
		var jsonResponse = eval('(' + o.responseText + ')');
		
		// loop over keys in JSON dictionary
		var html = getCloseLink("wget-scripts");
		
		// description
		html += "<div style='text-align:center'>For better performance, wget scripts are generated for each Index Node separately. "
		      + "<br/>Click on each link below to retrieve the script for each Index Node.</div>";
		
		html += "<div style='text-align:center'>";
		for (var index_node in jsonResponse) {
			  if (jsonResponse.hasOwnProperty(index_node)) {
				// NOTE: ids is an array but becomes a string when enclosed in ""
			    var ids = jsonResponse[index_node];
			    html += "<br/><a href='javascript:wgetScript(\""+index_node+"\",\""+ids+"\")'>wget script for "+index_node+"</a>";
			  }
		}
		html += "</div>";
		
		// display wget-script panel with new content
		wgetPanel = document.getElementById("wget-scripts");
		wgetPanel.innerHTML = html;
		wgetPanel.style.display = 'block';

	}
	
	// function to create wget scripts for all selected datasets
	function wgetDatasets() {
		
		//  wget endpoint
		var url = "{% url 'datacart_wget' site.id request.user.id %}";
		
		// loop over dataitem checkboxes to post id of selected datasets
		var postdata = ""
		var inputs = document.getElementsByTagName("input");
		for (var i = 0; i < inputs.length; i++) {
		    if (inputs[i].type == "checkbox") {
		    	if (inputs[i].id!=null && inputs[i].id.length>0 && inputs[i].id.indexOf("dataitem-checkbox")==0) {
		        	if (inputs[i].checked) {
		        		postdata += "&id="+inputs[i].name;
		        	}
		    	}
		    }  
		}
		
		if (postdata.length>0) {
			// execute asynchronous POST request
			var transaction = YAHOO.util.Connect.asyncRequest('POST', url, wgetCallback, postdata);
		} else {
			showMessage("Warning", "Please select one or more items in the Data Cart.");
		}
		
	}
	
	// function called if Ajax request failed
	var handleFailure = function(o) {		
		
		// hide waiting panel, in case it was displaying
		hideWaitPanel();

		// show error panel
		showMessage("An Error Occurred", "HTTP Status Code: "+o.status+"<br/>Message: "+o.statusText);
		
	}

	var addCallback = {
	  success:handleAddSuccess,
	  failure: handleFailure,
	  cache:false,
	  timeout:5000,
	  argument: [],
	};
	
	var deleteCallback = {
	  success:handleDeleteSuccess,
	  failure: handleFailure,
	  cache:false,
	  timeout:5000,
	  argument: [],
	};
	
	var filesCallback = {
	  success:handleFilesSuccess,
	  failure: handleFailure,
	  cache:false,
	  timeout: 20000, // longer timeout
	  argument: [],
	};
	
	var wgetCallback = {
	  success:handleWgetSuccess,
	  failure: handleFailure,
	  cache:false,
	  timeout:5000,
	  argument: [],
	};
	
</script>