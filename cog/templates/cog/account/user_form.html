<!-- Template page used to create a user account -->
<!--LOCATION: /cog/templates/cog/account/user_form.html-->
{% extends "cog/common/layout_center.html" %}

{% load cog_utils %}

{% block extrahead %}

	<!--<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.9.0/build/fonts/fonts-min.css"/>-->
    <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.9.0/build/autocomplete/assets/skins/sam/autocomplete.css" />
	<script type="text/javascript" src="http://yui.yahooapis.com/2.9.0/build/yahoo-dom-event/yahoo-dom-event.js"></script>
	<script type="text/javascript" src="http://yui.yahooapis.com/2.9.0/build/animation/animation-min.js"></script>
	<script type="text/javascript" src="http://yui.yahooapis.com/2.9.0/build/datasource/datasource-min.js"></script>
	<script type="text/javascript" src="http://yui.yahooapis.com/2.9.0/build/autocomplete/autocomplete-min.js"></script>

    <!-- note: must style the autocomplete containers otherwise it expands to fit the whole window-->
    <style scoped type="text/css">
        #countryAutoComplete {
            width:300px;
            padding-bottom: 8px;
        }
        #stateAutoComplete {
            width:300px;
            padding-bottom: 8px;
        }
    </style>

    {% include 'cog/account/_countries.html' %}
    {% include 'cog/account/_states.html' %}

    <script>
    //<![CDATA[

       function init() {
    	   // country
           var countryDataSource = new YAHOO.util.LocalDataSource(countryArray);
           var countryAutoComp = new YAHOO.widget.AutoComplete("id_country", "countryContainer", countryDataSource);
           countryAutoComp.prehighlightClassName = "yui-ac-prehighlight";
           countryAutoComp.useShadow = true;
           countryAutoComp.allowBrowserAutocomplete = false;
           // state
           var stateDataSource = new YAHOO.util.LocalDataSource(stateArray);
           var stateAutoComp = new YAHOO.widget.AutoComplete("id_state", "stateContainer", stateDataSource);
           stateAutoComp.prehighlightClassName = "yui-ac-prehighlight";
           stateAutoComp.useShadow = true;
           stateAutoComp.allowBrowserAutocomplete = false;
       }
       YAHOO.util.Event.onContentReady("userDiv", init);

    //]]>
    </script>
    
    <!-- JavaScript for checking passwords -->
    {% include 'cog/account/_password_checker.html' %}
    
{% endblock %}

{% block main %}
  <div class="prepend-1 span-22">

    <h2>{{ mytitle }}</h2>
    <p>Please provide the information below to request a CoG account. Required fields are in <b>bold</b>. 
    <br/>Upon submission, an OpenID will be automatically assigned to you: you will need that OpenID to login. 
    <br/>The following characters are not allowed: &lt; &gt; &amp; # % { } [ ] $ </p>

    <!-- display extra message if available -->
	{% if request.GET.message %}
	   <div class="message-box"> {{ request.GET.message|showMessage }}</div>
	   <br>
	{% endif %}
	
    <div class="yui-skin-sam">
	    <div class="mybox" id="userDiv">

			<!-- NOTE: form cannot be submitted unless password meets criteria -->
	        <form action="" method="post" enctype="multipart/form-data" onsubmit="return checkPassword();">
	        
	            {% csrf_token %}
	            {{ formset1.management_form }}
	            {{ formset2.management_form }}
	           <!--width specified for IE, which does not accept
	            width=99% as listed in the CSS for long-->

	            <table>
	                <tr>
	                    <td class="required" nowrap="nowrap"><label for="id_username">User Name</label></td>
	                    {% if form.instance.id %}
	                   		<td>{{ form.instance.username }} {{ form.username.as_hidden }}</td>
	                	{% else %}
	                   		<td>{{ form.username }}
	                        	<i>[ 5 to 30 characters, letters, digits and @/./+/-/_ only ]</i><br>{{ form.username.errors }}
	                    	</td>
	                   {% endif %}
	                </tr>
	                
             		<!-- OpenIDs: NOT for new accounts (since an OpenID is generated automatically) -->
              		{% if form.instance.id %}
              			{% for openidform in formset2 %}
	              			<tr>
	              				{{ openidform.id }}
	              				<td class="required" nowrap="nowrap"><label for="id_claimed_id">ESGF OpenID</label></td>
	              				<td style="width:500px;vertical-align:middle;">
	              					{{ openidform.instance.claimed_id }} 
	              					{{ openidform.claimed_id.as_hidden }}
	              				</td>
	              			</tr> 	
			    		{% endfor %}
		    		{% endif %}
	            
	             	<tr>
	                    <td class="required" nowrap="nowrap"><label for="id_first_name">First Name</label></td>
	                    <td>{{ form.first_name }} {{ form.first_name.errors }}</td>
	                </tr>
	                <tr>
	                    <td class="required" nowrap="nowrap"><label for="id_last_name">Last Name</label></td>
	                    <td >{{ form.last_name }} {{ form.last_name.errors }}</td>
	                </tr>
	                <tr>
	                    <td class="required" nowrap="nowrap"><label for="id_email">Email</label></td>
	                    <td>{{ form.email }} {{ form.email.errors }}</td>
	                </tr>
	                

	                <!-- existing COG users: the encrypted passwords are resubmitted as hidden fields -->
	                {% if form.instance.id %}

	                	{% if form.instance.profile.type == 1 %}
			            	<!-- existing user: include encoded password, confirm_password as hidden fields -->
		                	{{ form.password.as_hidden }}
		                    {{ form.confirm_password.as_hidden }}
	                    {% endif %}

	                <!-- new users: must submit a password, confirm password -->
	                {% else %}
		                <!-- otherwise, the user must submit a password -->
		                <tr>
		                    <td class="required" nowrap="nowrap"><label for="id_password">Password</label></td>
		                    <td>{{ form.password }}
		                       <br/><i>[ {{ form.password.help_text }} ]</i>
		                       {{ form.password.errors }}
		                       <div id="password_check" style="display:none; margin-top:2px; vertical-align: middle;" >
                                   &nbsp;
		                       </div>
		                    </td>
		                </tr>
		                <tr>
		                    <td class="required" nowrap="nowrap"><label for="id_confirm_password">Confirm Password</label></td>
		                    <td>{{ form.confirm_password }}
		                        <br/><i>[ {{ form.confirm_password.help_text }} ]</i>
		                        <br/>{{ form.confirm_password.errors }}
		                    </td>
		                </tr>
	                {% endif %}
	                <tr>
                        <td class="required" nowrap="nowrap"><label for="id_institution">Institution</label></td>
                        <td>{{ form.institution }} {{ form.institution.errors }}</td>
                    </tr>
                    <tr>
                        <td class="optional" nowrap="nowrap"><label for="id_department">Department</label></td>
                        <td class="long">{{ form.department }} {{ form.department.errors }}</td>
                    </tr>
                    <tr>
                        <td class="required" nowrap="nowrap"><label for="id_city">City</label></td>
                        <td class="long">{{ form.city }} {{ form.city.errors }}</td>
                    </tr>
                    <tr>
                        <td class="optional" nowrap="nowrap"><label for="id_state">State</label></td>
                        <td>
                            <div id="stateAutoComplete">
                            {{ form.state }} <div id="stateContainer"></div></div><br/> {{ form.state.errors }}
                        </td>
                    </tr>
                    <tr>
                        <td class="required" nowrap="nowrap"><label for="id_country">Country</label></td>
                        <td>
                            <div id="countryAutoComplete">
                            {{ form.country }} <div id="countryContainer"></div></div><br/> {{ form.country.errors }}
                        </td>
                    </tr>
                    <tr>
                        <td class="optional" nowrap="nowrap"><label for="id_researchKeywords">Interest Keywords</label></td>
                        <td>
                        [A short list of science fields you are involved with (60 characters maximum).
                        <br/>Example: Software Engineering, Grid Computing, Climate Change.]
                        <br/>{{ form.researchKeywords }} {{ form.researchKeywords.errors }}</td>
                    </tr>
                    <tr>
                        <td class="optional" nowrap="nowrap"><label for="id_researchInterests">Interest Statement</label></td>
                        <td>
                        [A short paragraph describing your professional interests (1000 characters maximum).]
                        <br/>{{ form.researchInterests }} {{ form.researchInterests.errors }}</td>
                    </tr>
                    <tr>
                        <td class="optional" nowrap="nowrap"><label for="id_subscribed">Subscribe to COG Email List?</label></td>
                        <td>{{ form.subscribed }} <i>[ 'cog_info', low traffic list ]</i> {{ form.subscribed.errors }}</td>
                    </tr>
                    <tr>
                        <td class="optional" nowrap="nowrap"><label for="id_private">Do not list me among project members</label></td>
                        <td>{{ form.private }} {{ form.private.errors }}</td>
                    </tr>
                    {% if not request.user.is_anonymous %}
	                    <tr>
	                      <td class="optional" nowrap="nowrap">Picture
	                        <br/>(Maximum Size: 1MB)
	                        <br/>(Format: 'jpg', 'png', or 'gif')
	                      </td>
	                      <td>
	                        <table>
	                          <tr>
	                        	<td>
	                        	<img alt="user_image" src="{{ form.instance|getImage }}" {% if not 'unknown' in form.instance|getImage %} class="myimage" {% endif %}/>
	                        	</td>
	                        	<td align="left">
				                  <div style="margin-top:2px">
				                    {% if not 'unknown' in form.instance|getImage %}
				                      {{ form.delete_image }} Delete current picture?
				                    {% endif %}
				                    <br>
				                    {{ form.image }}
				                    &nbsp;{{ form.image.errors }}
				                  </div>
	                            </td>
	                          </tr>
	                        </table>
	                      </td>
	                    </tr>
                    {% else %}
                        <tr>
                            <td>
                                <img alt="user_image" style="margin-top:4px;" src="/static/cog/img/unknown.thumbnail.jpeg">
                            </td>
                            <td colspan="2" class="optional" style="vertical-align: middle;">
                                Note: You may upload a picture to your profile after you login for the first time.
                            </td>
                        </tr>
                    {% endif %}
                </table>

	     <!--this section is its own table in order to make the td widths different from the one above-->
         <!--with the removal of the user image until after authentication, the color of this table now needs to vary
         depending upon whether or not a user is authenticated-->
         {% if not request.user.is_anonymous %}
	        <table class="odd-color">
         {% else %}
            <table>
         {% endif %}
				
		    	<!-- URLs -->
		    	<tr>
              	   <td colspan="6">[Optional web sites associated with this COG user account: (e.g. 'Home Page', 'My Blog') ]</td>
                </tr>
                {% for urlform in formset1 %}{{ urlform.id }}
				    <tr>
			           <td style="width:60px;vertical-align:middle;"><label for="id_url-{{forloop.counter0}}-url">Web URL:</label></td>
				       <td style="width:300px;vertical-align:middle;">{{ urlform.url }} {{ urlform.url.errors }}</td>
			           <td style="width:30px;vertical-align:middle;"><label for="id_url-{{forloop.counter0}}-name">Title:</label></td>
				       <td style="width:200px;vertical-align:middle;">{{ urlform.name }} {{ urlform.name.errors }}</td>
			           <td style="vertical-align:middle;">{{ urlform.DELETE }} <label for="id_url-{{forloop.counter0}}-DELETE">Delete?</label></td>
				    </tr>
		        {% endfor %}
 	        </table>

	            <div style="text-align:right;">
	                <hr/>
	                {% if request.user.is_anonymous %}
	                   <input type="button" value="Cancel" onclick="window.location='{% url 'site_home' %}'"/>
	                {% else %}
	                   <!-- prevent user with non-complete data to hit 'cancel' button -->
	                   {% if request.user|isValidUser and form.instance.id %}
	                   <input type="button" value="Cancel" onclick="window.location='{% url 'user_detail' form.instance.id %}'"/>
	                   {% endif %}
	                {% endif %}
	                <input type="submit" value="Submit" />
	            </div>

	        </form>
	    </div>
    </div>
</div>

{% endblock %}