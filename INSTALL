====================== COG INSTALLATION INSTRUCTIONS ======================================


>>> PRE-REQUISITES

*-nix OS, including Cent-OS, linuc and MacOSX
Python 2.7
Python virtualenv (pip install virtualenv)
Postgres (only if using Postgres back-end)

>>> INSTALLATION

0) Create a parent directory under which all CoG-related software (Python, CoG installation, CoG configuration)
will be installed. The directory can be located anywhere on the system. The user executing the installation
must have write permissions to this directory.

o export COG_DIR=/usr/local/cog
o mkdir $COG_DIR (if not existing already)

At the end of the installation process, the $COG_DIR will contain the follwing sub-directories:

$COG_DIR/
	|
	|--> cog_config/ : site-specific configuration and media files
	|--> cog_install/ : CoG source distribution
	|--> venv/: Python virtula environment (Python executable and all needed dependencies) 


1) Define Python virtual environment

create a directory where to install a specific distribution of Python and all its dependencies
needed by CoG:

o cd $COG_DIR
o virtualenv venv

will create the sub-directory venv with:
- copy of python executable in ./bin/python
- location for installation of additional needed packages in ./lib/python2.7/site-packages

o source venv/bin/activate
o which python
will show that the python installation used is located into the venv sub-directory

to later disactivate the Python virtual environment:

o deactivate

2) Install CoG

Create a directory to hold the CoG distribution,
checkout CoG from the GitHub repository (using a specific branch or tag)

o cd $COG_DIR
o git clone https://github.com/EarthSystemCoG/COG cog_install
or:
o git clone git@github.com:EarthSystemCoG/COG.git cog_install
o cd cog_install
o git checkout -b devel origin/devel
or for a specific tag:
o git checkout v2.6.2
o export COG_INSTALL_DIR=$COG_DIR/cog_install

3) Configure CoG

Create a directory to hold the local CoG configuration and all future CoG media

o export COG_CONFIG_DIR=$COG_DIR/cog_config
o mkdir $COG_CONFIG_DIR

o cd $COG_INSTALL_DIR
o python setup.py install

will install all necessary CoG dependencies under the CoG python installation in the location
$COG_PYTHON/lib/python2.7/site-packages

o python setup.py setup_cog
or to install CoG on an existing ESGF node:
o python setup.py setup_cog --esgf=true

will create the site configuration file under /usr/local/cog/cog_config/cog_settings.cfg
will create a site_media directory under /usr/local/cog/cog_config/site_media
will copy all CoG system media to /usr/local/cog/cog_install/static
	
if --esgf=false:
	- will create a startup sqllite database under /usr/local/cog/cog_config/django.data
	- if installing for the first time, it will create a "TestProject" and make that the CoG home project
	- if installing for the first time, it will create a super-user "admin" with password "changeit"
	
if --esgf=true:
	- will create a CoG database onto the ESGF Postgres installation
	- if installing for the first time, it will create a "TestProject" and make that the CoG home project
	- if installing for the first time, it will create a super-user "admin" with password "changeit" 
	  and openid 'https://<hostname>/esgf-idp/openid/admin (or the first available openid if that is taken already)

o rm -rf $COG_PYTHON/lib/python2.7/site-packages/cog*

will remove CoG from the python site-packages library,
to avoid conflicts with the source installation in $COG_DIR/cog_install

4) Run CoG

o cd $COG_INSTALL_DIR
o python manage.py runserver
o access URL at http://localhost:8000
o login as administrator:
	- if --esgf=true, use the standard login URL: http://<hostname>/login/ with the "admin" openid and password above
	- if --esgf=false, use the hidden local login: http://<hostname>/login2/ with the "admin" password above
	
o immediately change the "admin" password by clicking on "My Profile" -> "Change Password" 
  or directly accessing the URL "http://<hostname>/password/update/

o also change all other "admin" data to match a local user, 
especially the email address where all site-level notifications will be sent

o start experimenting with creating other projects and registering new users.

o test the email notification when new projects are created


5) Post-installation configuration

o Review the file $COG_CONFIG_DIR/cog_settings.cfg and modify values to reflect the
site specific configuration. Values set in this file will not be overridden by
future upgrades. Refer to the file resources/config/cog_settings.cfg (included with the distribution)
for description and example values of the configuration parameters.

o Optionally, provide a custom header and footer by placing content in the directories
$COG_CONFIG_DIR/mytemplates and $COG_CONFIG_DIR/mymedia

o If for any reason the name or domain of the current site needs to change, 
the new values should be entered in cog_settings.cfg, then run the command:

cd $COG_INSTALL_DIR
python manage.py init_site

o Setup federation with other CoG instances by visiting the URL:

http://<hostname>/cogadmin/peers/

The list of possible CoG peers is seeded from the file cog/management/commands/sites.xml that is distributed with the CoG application.

In order to load the most up-to-date list of peers into the local database, run the following django management command:

cd $COG_INSTALL_DIR
python manage.py sync_sites

This command will insert any missing sites in the local database (and update their names if they have changed), but will not activate the sites by default.
Note that the same command can also be passed the '--delete' option to delete stale sites that are found in the local database, but are missing from the sites.xml file:

python manage.py sync_sites --delete

Once the sites are listed in the local database, they can be enabled by logging in as a site administrator and clicking 
on the 'Configure Peers' link in the 'Admin' menu in the lower left navigation bar.

The local CoG application can be instructed to load the most recent list of projects from the other federated instances in one of three ways:

o By visiting the page "Configure Peers" and clicking on the lower link "Synchronize with Peer CoGs Now "
(or directly invoking the URL "http://<your cog domain name>/share/sync/projects/")

o By invoking the following django management command:

cd <COG installation directory>
python manage.py sync_projects

o By setting up a cron job that executes the same command above. For example:

crontab -l
0 * * * * source ~/.bashrc; python /usr/COG/manage.py sync_projects >> /tmp/crontab.log 2>&1

will parse the user environment, and run the command at minute 0 of every hour, appending the output to file.

NOTES: 
	- projects will be updated only from peer sites that are "enabled". 
	- IMPORTANT: a site will only share projects correctly if its 'Site' domainname equals its real domain.
	  If its site domain has been recently updated, CoG must be restarted for that change to take effect, otherwise
	  the other CoGs won't see its projects
	- a site will only share those projects that are both 'active' and 'public'
	
	
NOTE: if a CoG peer site is disabled through the admin interface:
	- Its projects won't show up in the projects browser (for none of the tabs)
	- Its projects will not be selectable as peers/parent/children in the project configuration panel
	- Its data cart won't show up in the current data cart page
	- The site will not be queried for user projects updates


o To restore the CoG database from backup:

Stop CoG, then:
- if using postgres:
psql -U postgres -p 5432 cogdb < cogdb_2014-03-12.sql
- if using sqllite:
simply copy the older django.data file to the DATABASE_PATH location 
Finally restart CoG




	
PERIODIC ADMINISTRATION TASKS

o Setup a cron job to periodically update the projects around the federation.
An example such script is provided as scripts/sync_projects.sh - which might need to be customized to your environment.

For example, to synchronize the projects every hour and append the log to a file:

0 * * * * /usr/COG/scripts/sync_projects.sh  >> /tmp/crontab.log 2>&1


o Setup a cron job to backup the postgres database content every night. 

An example script is provided as 'scripts/cog_backup.sh' - which might need to be customized to your specific installation.

For example, to backup the database every day at midnight:

0 0 * * * /usr/COG/scripts/cog_backup.sh

NOTE: to run as cron, the postgres database password must be located in file ~/.pgpass with the format:
host_name:port:database_name:database_user:database_password

Also must set the file permissionss as follows:

chmod 0600 ~/.pgpass

CUSTOMIZED HEADER AND FOOTER

The default header and footer can be overridden by placing a custom temaplate with the same name and system path under the
root level directory <COG_CONFIG_DIR>/mytemplates/<full path to template file>, where by default COG_CONFIG_DIR=/usr/local/cog (or COG_CONFIG_DIR can be set through an environment variable available to the CoG web container).

For example, to override the template cog/templates/cog/common/cog_header_custom.html and cog/templates/common/cog_footer_custom.html which come with the distribution, create the two custom files:

/usr/local/cog/mytemplates/cog/templates/common/cog_header_custom.html
/usr/local/cog/mytemplates/cog/templates/common/cog_footer_custom.html

Images and other media should be located under the directory <COG_CONFIG_DIR>/mymedia/ and referenced from within the template as "/mymedia/<image name>".

For example, the file located at /usr/local/cog/mymedia/nasa.jpeg can be loaded by any template as src="/mymedia/nasa.jpeg" (please note the first leading '/').

The directories resources/noaa/mytemplates and resources/noaa/mymedia contain some examples of custom header, footer and associated media.
